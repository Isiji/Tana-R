{% extends 'layout.html' %}
{% block title %}Create an Event{% endblock %}
{% block content %}
<!--uses the labels from the eventform-->
<div class="container">
    <h2>Create an Event</h2>
    <form method="POST" action="{{ url_for('events.add_event') }}">
        {{ form.hidden_tag() }}
        <div class="form-group">
            {{ form.event_name.label(class="form-control-label") }}
            {{ form.event_name(class="form-control form-control-lg") }}
            {% if form.event_name.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_name.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.impact_level.label(class="form-control-label") }}
            {{ form.impact_level(class="form-control form-control-lg") }}
            {% if form.impact_level.errors %}
            <div class="invalid-feedback">
                {% for error in form.impact_level.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.event_date.label(class="form-control-label") }}
            {{ form.event_date(class="form-control form-control-lg") }}
            {% if form.event_date.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_date.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.event_owner.label(class="form-control-label") }}
            {{ form.event_owner(class="form-control form-control-lg") }}
            {% if form.event_owner.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_owner.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.event_contact.label(class="form-control-label") }}
            {{ form.event_contact(class="form-control form-control-lg") }}
            {% if form.event_contact.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_contact.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.event_location.label(class="form-control-label") }}
            {{ form.event_location(class="form-control form-control-lg") }}
            {% if form.event_location.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_location.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="form-group">
            {{ form.event_description.label(class="form-control-label") }}
            {{ form.event_description(class="form-control form-control-lg") }}
            {% if form.event_description.errors %}
            <div class="invalid-feedback">
                {% for error in form.event_description.errors %}
                <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Polling Station Selection -->
        <div class="container mt-5">
            <h2>Select Polling Station</h2>
            <div class="form-group">
                <label for="pollingStation">Polling Station</label>
                <div class="input-group">
                    <select id="pollingStationSelect" class="form-control" onchange="fetchDetails()">
                        <option value="">Select a Polling Station</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="ward">Ward</label>
                <input type="text" id="ward" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="constituency">Constituency</label>
                <input type="text" id="constituency" class="form-control" readonly>
            </div>
        </div>

        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<script>
    async function fetchPollingStationNames() {
        try {
            const response = await fetch('/get_all_polling_stations');
            const data = await response.json();
            const pollingStationNames = data.pollingStations;
            const pollingStationSelect = document.getElementById('pollingStationSelect');
            pollingStationSelect.innerHTML = '<option value="">Select a Polling Station</option>'; // Clear existing options
            pollingStationNames.forEach((pollingStationName) => {
                const option = document.createElement('option');
                option.value = pollingStationName;
                option.textContent = pollingStationName;
                pollingStationSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching polling station names:', error);
            const pollingStationSelect = document.getElementById('pollingStationSelect');
            pollingStationSelect.innerHTML = '<option value="">Error loading polling stations</option>';
        }
    }

    async function fetchDetails() {
        const pollingStationSelect = document.getElementById('pollingStationSelect');
        const selectedPollingStation = pollingStationSelect.value.trim();

        if (!selectedPollingStation) {
            document.getElementById('ward').value = '';
            document.getElementById('constituency').value = '';
            return;
        }

        try {
            const url = `/get_polling_station_info?polling_station=${selectedPollingStation}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.error) {
                document.getElementById('ward').value = '';
                document.getElementById('constituency').value = '';
                alert(data.error);
            } else {
                document.getElementById('ward').value = data.ward;
                document.getElementById('constituency').value = data.constituency;
            }
        } catch (error) {
            console.error('Error fetching details:', error);
            alert('Error fetching details. Please try again.');
        }
    }

    document.addEventListener('DOMContentLoaded', fetchPollingStationNames);
</script>
{% endblock %}
